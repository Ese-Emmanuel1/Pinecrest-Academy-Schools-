<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>PineCrest Academy — Online Admission Form</title>
  <meta name="description" content="Official PineCrest Academy Admission Portal — Creche to SSS3" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <!-- html2canvas for capturing the receipt -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- PDF and Supabase libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* =============== Pinecrest Global Styles (from main site) =============== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      overflow-x: hidden;
      color: #333;
      background-color: #f5f7fa;
      max-width: 100vw;
    }

    /* =============== Reuse Header & Nav from Main Site =============== */
    header {
      background: rgba(255, 255, 255, 0.98);
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
      position: fixed;
      width: 100%;
      z-index: 1000;
      padding: 12px 5%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 100vw;
      transition: all 0.3s ease;
      border-bottom: 1px solid rgba(26, 95, 180, 0.1);
    }
    .logo-container {
      display: flex;
      align-items: center;
    }
    .logo {
      width: 55px;
      height: 55px;
      margin-right: 15px;
      background: linear-gradient(135deg, #1a5fb4 0%, #1c71d8 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 22px;
      font-weight: bold;
      border: 2px solid #fff;
      box-shadow: 0 0 0 2px #1a5fb4;
    }
    .logo-text {
      font-size: 22px;
      font-weight: 700;
      color: #1a5fb4;
      letter-spacing: 0.5px;
    }
    .school-motto {
      font-style: italic;
      color: #1a5fb4;
      font-weight: 600;
      margin-left: 20px;
      padding-left: 20px;
      border-left: 2px solid #1a5fb4;
      text-shadow: 0 0 5px rgba(26, 95, 180, 0.2);
    }
    nav ul {
      display: flex;
      list-style: none;
    }
    nav ul li {
      margin: 0 12px;
      position: relative;
    }
    nav ul li a {
      text-decoration: none;
      color: #444;
      font-weight: 600;
      font-size: 16px;
      transition: color 0.3s;
      padding: 8px 5px;
      position: relative;
    }
    nav ul li a::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 0;
      height: 2px;
      background: #1a5fb4;
      transition: width 0.3s ease;
    }
    nav ul li a:hover::after {
      width: 100%;
    }
    nav ul li a:hover {
      color: #1a5fb4;
    }
    .hamburger {
      display: none;
      flex-direction: column;
      cursor: pointer;
      z-index: 1002;
      padding: 8px;
    }
    .hamburger span {
      width: 28px;
      height: 3px;
      background: #1a5fb4;
      margin: 3px 0;
      border-radius: 2px;
      transition: all 0.3s ease;
    }

    /* =============== Mobile Nav Drawer (from main site) =============== */
    .overlay-nav {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: none;
    }
    .mobile-nav {
      position: fixed;
      top: 0;
      right: -300px;
      width: 300px;
      height: 100vh;
      background: white;
      box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
      z-index: 1001;
      transition: right 0.3s ease-in-out;
      padding: 60px 20px 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .mobile-nav.active {
      right: 0;
    }
    .close-nav {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 24px;
      cursor: pointer;
      color: #1a5fb4;
      background: rgba(26, 95, 180, 0.1);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .mobile-nav ul {
      list-style: none;
      margin-top: 20px;
    }
    .mobile-nav ul li {
      margin-bottom: 10px;
    }
    .mobile-nav ul li a {
      display: block;
      padding: 15px;
      color: #333;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .mobile-nav ul li a:hover {
      background-color: #f0f7ff;
      color: #1a5fb4;
    }
    .mobile-nav-header {
      padding: 15px 0;
      border-bottom: 1px solid #eee;
      margin-bottom: 15px;
    }

    /* =============== Main Content =============== */
    .main-wrapper {
      padding-top: 100px;
      padding-bottom: 80px;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 0 20px;
    }
    .page-header {
      text-align: center;
      margin-bottom: 40px;
    }
    .page-header h1 {
      font-family: 'Playfair Display', serif;
      font-size: 28px;
      color: #1a5fb4;
      margin-bottom: 12px;
    }
    .page-header p {
      color: #666;
      font-size: 16px;
    }

    /* =============== Form Styles (Pinecrest-themed) =============== */
    .admission-shell {
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(26, 95, 180, 0.1);
      overflow: hidden;
      border: 1px solid #eaeff5;
    }
    .form-body {
      padding: 30px;
    }
    .steps {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      padding: 12px;
      background: #f8fafc;
      border-radius: 14px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .steps::-webkit-scrollbar {
      display: none;
    }
    .step {
      min-width: 110px;
      padding: 10px 8px;
      text-align: center;
      font-size: 13px;
      color: #6c757d;
      font-weight: 600;
      background: white;
      border-radius: 10px;
      flex-shrink: 0;
    }
    .step.active {
      background: linear-gradient(135deg, #1a5fb4, #1c71d8);
      color: white;
      box-shadow: 0 4px 12px rgba(26, 95, 180, 0.2);
    }

    label {
      display: block;
      margin: 16px 0 8px;
      font-weight: 600;
      color: #1a5fb4;
      font-size: 15px;
    }
    input, select, textarea {
      width: 100%;
      padding: 14px;
      border: 1px solid #d1d9e6;
      border-radius: 12px;
      font-family: 'Poppins', sans-serif;
      font-size: 16px;
      background: #fafbff;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #1a5fb4;
      background: white;
    }
    textarea {
      min-height: 120px;
      resize: vertical;
    }
    .grid {
      display: grid;
      gap: 20px;
    }
    .grid-2 {
      grid-template-columns: 1fr 1fr;
    }
    .grid-3 {
      grid-template-columns: 1fr 1fr 1fr;
    }
    @media (max-width: 768px) {
      .grid-2, .grid-3 {
        grid-template-columns: 1fr;
      }
    }

    /* Passport Photo Upload */
    .photo-upload-container {
      border: 2px dashed #1a5fb4;
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      background: #f8f9ff;
      margin: 20px 0;
      transition: all 0.3s ease;
    }
    .photo-upload-container.dragover {
      background: #e6f0ff;
      border-color: #1c71d8;
    }
    .photo-preview {
      width: 150px;
      height: 180px;
      margin: 0 auto 20px;
      border: 2px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      background: #fff;
      display: none;
    }
    .photo-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .photo-upload-label {
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 24px;
      background: linear-gradient(135deg, #1a5fb4, #1c71d8);
      color: white;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .photo-upload-label:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(26, 95, 180, 0.3);
    }
    #photoInput {
      display: none;
    }
    .photo-requirements {
      font-size: 14px;
      color: #666;
      margin-top: 10px;
    }
    .photo-error {
      color: #dc3545;
      font-size: 14px;
      margin-top: 8px;
      display: none;
    }

    /* Academic Report Upload */
    .report-upload-container {
      border: 2px dashed #28a745;
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      background: #f8fff9;
      margin: 20px 0;
      transition: all 0.3s ease;
    }
    .report-upload-container.dragover {
      background: #e6ffe6;
      border-color: #20c997;
    }
    .report-preview {
      width: 200px;
      height: 260px;
      margin: 0 auto 20px;
      border: 2px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      background: #fff;
      display: none;
    }
    .report-preview img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    .report-upload-label {
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 24px;
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .report-upload-label:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }
    #reportInput {
      display: none;
    }
    .report-requirements {
      font-size: 14px;
      color: #666;
      margin-top: 10px;
    }
    .report-error {
      color: #dc3545;
      font-size: 14px;
      margin-top: 8px;
      display: none;
    }

    .actions {
      display: flex;
      gap: 12px;
      margin-top: 28px;
      padding-top: 20px;
      border-top: 1px solid #eaeff5;
    }
    @media (max-width: 600px) {
      .actions {
        flex-direction: column;
      }
    }
    .btn {
      padding: 14px 24px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      text-align: center;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s ease;
      border: none;
    }
    .btn-primary {
      background: linear-gradient(135deg, #1a5fb4, #1c71d8);
      color: white;
      flex: 1;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(26, 95, 180, 0.3);
    }
    .btn-outline {
      background: transparent;
      color: #1a5fb4;
      border: 2px solid #1a5fb4;
      flex: 1;
    }
    .btn-outline:hover {
      background: #f0f7ff;
    }
    .btn-success {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      flex: 1;
    }
    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(40, 167, 69, 0.3);
    }
    .btn-warning {
      background: linear-gradient(135deg, #ffc107, #fd7e14);
      color: white;
      flex: 1;
    }
    .btn-warning:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(255, 193, 7, 0.3);
    }

    .required-note {
      background: #f8f9ff;
      padding: 14px;
      border-radius: 10px;
      margin: 20px 0;
      font-size: 14px;
      color: #666;
      border-left: 4px solid #1a5fb4;
    }

    #statusMsg {
      padding: 14px;
      border-radius: 10px;
      margin: 20px 0;
      font-weight: 600;
      display: none;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    /* =============== Receipt/Preview Styles =============== */
    .receipt-container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(26, 95, 180, 0.1);
      overflow: hidden;
      border: 1px solid #eaeff5;
      max-width: 800px;
      margin: 40px auto;
      display: none;
    }
    .receipt-header {
      background: linear-gradient(135deg, #1a5fb4, #1c71d8);
      color: white;
      padding: 30px;
      text-align: center;
    }
    .receipt-header h2 {
      font-family: 'Playfair Display', serif;
      font-size: 28px;
      margin-bottom: 10px;
    }
    .receipt-header p {
      opacity: 0.9;
    }
    .receipt-body {
      padding: 30px;
    }
    .receipt-stamp {
      position: absolute;
      top: 20px;
      right: 20px;
      color: #1a5fb4;
      font-size: 24px;
      opacity: 0.7;
    }
    .receipt-info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .info-item {
      margin-bottom: 15px;
    }
    .info-label {
      font-weight: 600;
      color: #1a5fb4;
      margin-bottom: 5px;
    }
    .info-value {
      color: #333;
      padding: 8px;
      background: #f8f9ff;
      border-radius: 8px;
    }
    .receipt-photo-container {
      width: 120px;
      height: 140px;
      border: 2px solid #1a5fb4;
      border-radius: 8px;
      overflow: hidden;
      margin: 20px auto;
      background: #f8f9ff;
    }
    .receipt-photo-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .receipt-footer {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 2px dashed #ddd;
      text-align: center;
    }
    .receipt-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    .application-id {
      background: #1a5fb4;
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      display: inline-block;
      margin-bottom: 15px;
    }
    .watermark {
      position: absolute;
      opacity: 0.1;
      font-size: 120px;
      transform: rotate(-45deg);
      z-index: 0;
    }
    .confirmation-text {
      background: #f0f7ff;
      padding: 20px;
      border-radius: 10px;
      margin: 25px 0;
      border-left: 4px solid #1a5fb4;
      font-style: italic;
      color: #333;
      line-height: 1.6;
    }

    /* Progress Bar */
    .upload-progress {
      width: 100%;
      background-color: #f0f0f0;
      border-radius: 10px;
      margin: 20px 0;
      display: none;
    }
    .upload-progress-bar {
      height: 10px;
      background: linear-gradient(90deg, #1a5fb4, #1c71d8);
      border-radius: 10px;
      width: 0%;
      transition: width 0.3s ease;
    }
    .upload-progress-text {
      text-align: center;
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }

    /* =============== Footer (from main site) =============== */
    footer {
      background: #1a2a3a;
      color: #fff;
      padding: 70px 5% 30px;
      max-width: 100vw;
      overflow-x: hidden;
    }
    .footer-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 40px;
      max-width: 1200px;
      margin: 0 auto 50px;
    }
    .footer-col h3 {
      font-size: 1.5rem;
      margin-bottom: 25px;
      position: relative;
      padding-bottom: 10px;
    }
    .footer-col h3::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 50px;
      height = 3px;
      background: #1a5fb4;
    }
    .footer-links {
      list-style: none;
    }
    .footer-links li {
      margin-bottom: 15px;
    }
    .footer-links a {
      color: #ccc;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .contact-info-footer {
      list-style: none;
    }
    .contact-info-footer li {
      margin-bottom: 15px;
      display: flex;
      align-items: flex-start;
      gap: 15px;
    }
    .contact-icon-footer {
      color: #1a5fb4;
      font-size: 1.2rem;
      margin-top: 3px;
    }
    .social-links {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }
    .social-links a {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      color: #fff;
    }
    .footer-bottom {
      text-align: center;
      padding-top: 30px;
      margin-top: 50px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 0.9rem;
      color: #aaa;
    }

    /* =============== Responsive =============== */
    @media (max-width: 992px) {
      .school-motto { display: none; }
    }
    @media (max-width: 768px) {
      header { padding: 12px 15px; }
      .hamburger { display: flex; margin-left: auto; }
      nav { display: none; }
      .main-wrapper { padding-top: 100px; }
      .receipt-header { padding: 20px; }
      .receipt-body { padding: 20px; }
      .receipt-actions {
        flex-direction: column;
      }
      .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- === EXACT SAME HEADER & NAV FROM MAIN SITE === -->
  <div class="overlay-nav" id="overlayNav"></div>
  <div class="mobile-nav" id="mobileNav">
    <div class="close-nav" id="closeNav">&times;</div>
    <div class="mobile-nav-header">
      <div class="logo-container">
        <div class="logo">PA</div>
        <div class="logo-text">Pinecrest Academy</div>
      </div>
    </div>
    <ul>
      <li><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
      <li><a href="about.html"><i class="fas fa-info-circle"></i> About</a></li>
      <li><a href="academics.html"><i class="fas fa-book"></i> Academics</a></li>
      <li><a href="admission.html" class="active"><i class="fas fa-user-graduate"></i> Admissions</a></li>
      <li><a href="resultchecker.html"><i class="fas fa-check-circle"></i> Check Result</a></li>
      <li><a href="sport.html"><i class="fas fa-basketball-ball"></i> Sports</a></li>
      <li><a href="news.html"><i class="fas fa-newspaper"></i> News</a></li>
      <li><a href="contact_us.html"><i class="fas fa-envelope"></i> Contact</a></li>
      <li><a href="gallery.html"><i class="fas fa-book-open"></i> Gallery</a></li>
    </ul>
  </div>

  <header>
    <div class="logo-container">
      <div class="logo">PA</div>
      <div class="logo-text">Pinecrest Academy</div>
      <div class="school-motto">Excellence Through Knowledge & Character</div>
    </div>
    <div class="hamburger" id="hamburger-menu">
      <span></span>
      <span></span>
      <span></span>
    </div>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="academics.html">Academics</a></li>
        <li><a href="admission.html">Admissions</a></li>
        <li><a href="resultchecker.html">Check Result</a></li>
        <li><a href="sport.html">Sports</a></li>
        <li><a href="news.html">News</a></li>
        <li><a href="contact_us.html">Contact</a></li>
        <li><a href="gallery.html">Gallery</a></li>
      </ul>
    </nav>
  </header>

  <!-- === ADMISSION FORM CONTENT === -->
  <div class="main-wrapper">
    <div class="container">
      <div class="page-header">
        <h1>Online Admission Application</h1>
        <p>For students from Creche through SSS3</p>
      </div>

      <!-- Upload Progress Bar -->
      <div class="upload-progress" id="uploadProgress">
        <div class="upload-progress-bar" id="uploadProgressBar"></div>
        <div class="upload-progress-text" id="uploadProgressText">Uploading PDF to storage...</div>
      </div>

      <!-- Form Container -->
      <div class="admission-shell" id="formContainer">
        <div class="form-body">
          <div class="steps" role="tablist">
            <div class="step active">Student Info</div>
            <div class="step">Parent Info</div>
            <div class="step">Upload Photo</div>
            <div class="step">Academic Report</div>
            <div class="step">Health Info</div>
            <div class="step">Review & Submit</div>
          </div>

          <form id="admissionForm" novalidate>
            <!-- Fieldset 1: Student Info -->
            <fieldset data-step="1" class="form-step">
              <div class="grid grid-2">
                <div>
                  <label for="surname">Surname *</label>
                  <input id="surname" name="surname" type="text" required placeholder="Enter surname">
                </div>
                <div>
                  <label for="othernames">Other Names *</label>
                  <input id="othernames" name="othernames" type="text" required placeholder="Enter other names">
                </div>
              </div>
              <div class="grid grid-2">
                <div>
                  <label for="dob">Date of Birth *</label>
                  <input id="dob" name="dob" type="date" required>
                </div>
                <div>
                  <label for="gender">Gender *</label>
                  <select id="gender" name="gender" required>
                    <option value="">Select Gender</option>
                    <option>Male</option>
                    <option>Female</option>
                    <option>Prefer not to say</option>
                  </select>
                </div>
              </div>
              <div>
                <label for="classApplied">Class Applying For *</label>
                <select id="classApplied" name="classApplied" required>
                  <option value="">Select Class</option>
                  <option>Creche</option>
                  <option>Nursery</option>
                  <option>Primary 1</option>
                  <option>Primary 2</option>
                  <option>Primary 3</option>
                  <option>Primary 4</option>
                  <option>Primary 5</option>
                  <option>Primary 6</option>
                  <option>JSS1</option>
                  <option>JSS2</option>
                  <option>JSS3</option>
                  <option>SSS1</option>
                  <option>SSS2</option>
                  <option>SSS3</option>
                </select>
              </div>
              <div class="grid grid-2">
                <div>
                  <label for="currentSchool">Current/Previous School</label>
                  <input id="currentSchool" name="currentSchool" type="text" placeholder="If applicable">
                </div>
                <div>
                  <label for="sessionApplied">Session Applying For *</label>
                  <select id="sessionApplied" name="sessionApplied" required>
                    <option value="">Select Session</option>
                    <option>2025/2026 Academic Session</option>
                    <option>2026/2027 Academic Session</option>
                    <option>2027/2028 Academic Session</option>
                  </select>
                </div>
              </div>
              <div class="required-note">
                <i class="fas fa-asterisk" style="color:#1a5fb4;"></i> All fields marked with * are required.
              </div>
              <div class="actions">
                <button type="button" class="btn btn-primary" id="nextBtn1">
                  Next: Parent Info <i class="fas fa-arrow-right"></i>
                </button>
              </div>
            </fieldset>

            <!-- Fieldset 2: Parent Info -->
            <fieldset data-step="2" class="form-step" style="display:none">
              <div class="grid grid-2">
                <div>
                  <label for="parentName">Parent/Guardian Full Name *</label>
                  <input id="parentName" name="parentName" type="text" required placeholder="Full name">
                </div>
                <div>
                  <label for="relationship">Relationship to Student *</label>
                  <input id="relationship" name="relationship" type="text" placeholder="e.g., Mother, Father" required>
                </div>
              </div>
              <div class="grid grid-2">
                <div>
                  <label for="phone">Phone Number *</label>
                  <input id="phone" name="phone" type="tel" required placeholder="Active phone number">
                </div>
                <div>
                  <label for="email">Email Address</label>
                  <input id="email" name="email" type="email" placeholder="parent@example.com">
                </div>
              </div>
              <div>
                <label for="address">Home Address *</label>
                  <input id="address" name="address" type="text" required placeholder="Full residential address">
              </div>
              <div class="grid grid-2">
                <div>
                  <label for="occupation">Occupation</label>
                  <input id="occupation" name="occupation" type="text" placeholder="Parent's occupation">
                </div>
                <div>
                  <label for="officeAddress">Office Address</label>
                  <input id="officeAddress" name="officeAddress" type="text" placeholder="If applicable">
                </div>
              </div>
              <div class="actions">
                <button type="button" class="btn btn-outline" id="prevBtn2">
                  <i class="fas fa-arrow-left"></i> Previous
                </button>
                <button type="button" class="btn btn-primary" id="nextBtn2">
                  Next: Upload Photo <i class="fas fa-arrow-right"></i>
                </button>
              </div>
            </fieldset>

            <!-- Fieldset 3: Passport Photo Upload -->
            <fieldset data-step="3" class="form-step" style="display:none">
              <div class="photo-upload-container" id="photoUploadContainer">
                <div class="photo-preview" id="photoPreview">
                  <img id="previewImage" src="" alt="Passport Preview">
                </div>
                <input type="file" id="photoInput" accept="image/*" capture="user">
                <label for="photoInput" class="photo-upload-label">
                  <i class="fas fa-camera"></i> Upload Passport Photograph
                </label>
                <div class="photo-requirements">
                  <p><i class="fas fa-info-circle"></i> Requirements:</p>
                  <ul style="text-align: left; display: inline-block; margin-top: 10px;">
                    <li>Recent passport photograph (taken within 6 months)</li>
                    <li>White background preferred</li>
                    <li>Clear face, looking directly at camera</li>
                    <li>File size: Max 2MB</li>
                    <li>Formats: JPG, PNG, or JPEG</li>
                  </ul>
                </div>
                <div class="photo-error" id="photoError">
                  <i class="fas fa-exclamation-circle"></i> <span id="photoErrorText"></span>
                </div>
              </div>
              <div class="required-note">
                <i class="fas fa-exclamation-triangle" style="color:#dc3545;"></i> Passport photograph is <strong>COMPULSORY</strong> for admission processing.
              </div>
              <div class="actions">
                <button type="button" class="btn btn-outline" id="prevBtn3">
                  <i class="fas fa-arrow-left"></i> Previous
                </button>
                <button type="button" class="btn btn-primary" id="nextBtn3">
                  Next: Academic Report <i class="fas fa-arrow-right"></i>
                </button>
              </div>
            </fieldset>

            <!-- Fieldset 4: Academic Report Upload -->
            <fieldset data-step="4" class="form-step" style="display:none">
              <div class="report-upload-container" id="reportUploadContainer">
                <div class="report-preview" id="reportPreview">
                  <img id="previewReport" src="" alt="Academic Report Preview">
                </div>
                <input type="file" id="reportInput" accept="image/*,.pdf">
                <label for="reportInput" class="report-upload-label">
                  <i class="fas fa-file-upload"></i> Upload Previous School Academic Report
                </label>
                <div class="report-requirements">
                  <p><i class="fas fa-info-circle"></i> Requirements:</p>
                  <ul style="text-align: left; display: inline-block; margin-top: 10px;">
                    <li>Most recent academic report/result</li>
                    <li>Acceptable formats: PDF, JPG, PNG, JPEG</li>
                    <li>File size: Max 5MB</li>
                    <li>Clear and legible scan or photo</li>
                    <li><strong>Note:</strong> For Nursery/Creche applicants without previous reports, upload a birth certificate or immunization record</li>
                  </ul>
                </div>
                <div class="report-error" id="reportError">
                  <i class="fas fa-exclamation-circle"></i> <span id="reportErrorText"></span>
                </div>
              </div>
              <div class="required-note">
                <i class="fas fa-exclamation-triangle" style="color:#28a745;"></i> Academic report is <strong>REQUIRED</strong> for admission screening (except Nursery/Creche applicants).
              </div>
              <div class="actions">
                <button type="button" class="btn btn-outline" id="prevBtn4">
                  <i class="fas fa-arrow-left"></i> Previous
                </button>
                <button type="button" class="btn btn-primary" id="nextBtn4">
                  Next: Health Info <i class="fas fa-arrow-right"></i>
                </button>
              </div>
            </fieldset>

            <!-- Fieldset 5: Health Info -->
            <fieldset data-step="5" class="form-step" style="display:none">
              <div class="grid grid-2">
                <div>
                  <label for="allergies">Allergies (if any)</label>
                  <input id="allergies" name="allergies" type="text" placeholder="e.g., Peanuts, None">
                </div>
                <div>
                  <label for="medical">Medical Conditions</label>
                  <input id="medical" name="medical" type="text" placeholder="e.g., Asthma, Diabetes">
                </div>
              </div>
              <div>
                <label for="emergencyContact">Emergency Contact *</label>
                  <input id="emergencyContact" name="emergencyContact" type="text" placeholder="Name & Phone Number" required>
              </div>
              <div>
                <label for="doctorName">Doctor's Name & Contact</label>
                <input id="doctorName" name="doctorName" type="text" placeholder="Family doctor (optional)">
              </div>
              <div class="actions">
                <button type="button" class="btn btn-outline" id="prevBtn5">
                  <i class="fas fa-arrow-left"></i> Previous
                </button>
                <button type="button" class="btn btn-primary" id="nextBtn5">
                  Review Application <i class="fas fa-arrow-right"></i>
                </button>
              </div>
            </fieldset>

            <!-- Fieldset 6: Review & Submit -->
            <fieldset data-step="6" class="form-step" style="display:none">
              <div style="background:#f8f9ff;padding:20px;border-radius:12px;margin-bottom:24px;">
                <h4 style="color:#1a5fb4;margin-bottom:16px;font-weight:600;">Review Your Application</h4>
                <div class="grid grid-2">
                  <div><strong>Student:</strong> <span id="review-student-name">-</span></div>
                  <div><strong>DOB:</strong> <span id="review-dob">-</span></div>
                  <div><strong>Gender:</strong> <span id="review-gender">-</span></div>
                  <div><strong>Class:</strong> <span id="review-class">-</span></div>
                  <div><strong>Session:</strong> <span id="review-session">-</span></div>
                  <div><strong>Parent:</strong> <span id="review-parent">-</span></div>
                  <div><strong>Relationship:</strong> <span id="review-relationship">-</span></div>
                  <div><strong>Phone:</strong> <span id="review-phone">-</span></div>
                  <div><strong>Email:</strong> <span id="review-email">-</span></div>
                  <div><strong>Address:</strong> <span id="review-address">-</span></div>
                  <div><strong>Occupation:</strong> <span id="review-occupation">-</span></div>
                  <div><strong>Medical:</strong> <span id="review-medical">-</span></div>
                  <div><strong>Allergies:</strong> <span id="review-allergies">-</span></div>
                  <div><strong>Emergency:</strong> <span id="review-emergency">-</span></div>
                  <div><strong>Doctor:</strong> <span id="review-doctor">-</span></div>
                </div>
                <div style="text-align:center; margin-top:20px;">
                  <div style="font-weight:600; color:#1a5fb4; margin-bottom:10px;">Passport Photograph:</div>
                  <div id="review-photo-preview" style="width:100px;height:120px;border:1px solid #ddd;border-radius:5px;margin:0 auto;overflow:hidden;background:#f8f9ff;">
                    <img id="review-photo" src="" alt="Passport" style="width:100%;height:100%;object-fit:cover;">
                  </div>
                  <div style="font-weight:600; color:#28a745; margin-top:15px;">Academic Report: <span id="review-report-status">Uploaded</span></div>
                </div>
              </div>
              <div class="required-note">
                <i class="fas fa-check-circle" style="color:#28a745;"></i> Please review all information carefully before submitting. After submission, your application will be saved as PDF and uploaded to secure storage.
              </div>
              <div class="actions">
                <button type="button" class="btn btn-outline" id="prevBtn6">
                  <i class="fas fa-arrow-left"></i> Previous
                </button>
                <button type="submit" class="btn btn-success" id="submitBtn">
                  <i class="fas fa-paper-plane"></i> Submit Application
                </button>
              </div>
            </fieldset>
          </form>

          <div id="statusMsg"></div>
        </div>
      </div>

      <!-- Receipt/Preview Container -->
      <div class="receipt-container" id="receiptContainer">
        <div class="receipt-header">
          <h2>Pinecrest Academy</h2>
          <p>Admission Application Receipt</p>
          <div class="receipt-stamp">
            <i class="fas fa-stamp"></i>
          </div>
        </div>
        <div class="receipt-body">
          <div class="application-id" id="receiptAppId">APPLICATION ID: -</div>
          <div class="watermark">Pinecrest</div>
          
          <div style="text-align:center; margin:20px 0;">
            <div class="receipt-photo-container">
              <img id="receiptPhoto" src="" alt="Passport">
            </div>
          </div>
          
          <div class="receipt-info-grid">
            <div class="info-item">
              <div class="info-label">Student Name:</div>
              <div class="info-value" id="receiptStudentName">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Date of Birth:</div>
              <div class="info-value" id="receiptDOB">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Gender:</div>
              <div class="info-value" id="receiptGender">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Class Applied:</div>
              <div class="info-value" id="receiptClass">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Session Applied:</div>
              <div class="info-value" id="receiptSession">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Parent/Guardian:</div>
              <div class="info-value" id="receiptParent">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Relationship:</div>
              <div class="info-value" id="receiptRelationship">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Phone Number:</div>
              <div class="info-value" id="receiptPhone">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Email:</div>
              <div class="info-value" id="receiptEmail">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Address:</div>
              <div class="info-value" id="receiptAddress">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Current School:</div>
              <div class="info-value" id="receiptSchool">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Medical Conditions:</div>
              <div class="info-value" id="receiptMedical">None</div>
            </div>
            <div class="info-item">
              <div class="info-label">Allergies:</div>
              <div class="info-value" id="receiptAllergies">None</div>
            </div>
            <div class="info-item">
              <div class="info-label">Emergency Contact:</div>
              <div class="info-value" id="receiptEmergency">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Application Date:</div>
              <div class="info-value" id="receiptDate">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">PDF Status:</div>
              <div class="info-value" id="receiptPDFStatus" style="color:#28a745; font-weight:600;">GENERATED & UPLOADED</div>
            </div>
            <div class="info-item">
              <div class="info-label">Application Status:</div>
              <div class="info-value" style="color:#28a745; font-weight:600;">SUBMITTED</div>
            </div>
          </div>
          
          <div class="confirmation-text">
            <i class="fas fa-info-circle" style="color:#1a5fb4; margin-right:10px;"></i>
            This slip confirms that the above-named applicant has successfully completed and submitted an online application. The applicant is required to present this slip at the school for admission processing.
          </div>
          
          <div class="receipt-footer">
            <p><strong>Important Notes:</strong></p>
            <p style="color:#666; font-size:14px; margin-top:10px;">
              1. This receipt confirms your application submission.<br>
              2. Your application has been saved as PDF in secure storage.<br>
              3. You will be contacted for screening and interview within 7 working days.<br>
              4. Bring this slip and original documents when invited.<br>
              5. For inquiries, contact: admissions@pinecrestacademy.edu
            </p>
            <div class="receipt-actions">
              <button class="btn btn-outline" id="printReceiptBtn">
                <i class="fas fa-print"></i> Print Receipt
              </button>
              <button class="btn btn-primary" id="downloadPDFBtn">
                <i class="fas fa-file-pdf"></i> Download PDF
              </button>
              <button class="btn btn-warning" id="downloadImageBtn">
                <i class="fas fa-download"></i> Download as Image
              </button>
              <button class="btn btn-success" id="newApplicationBtn">
                <i class="fas fa-plus"></i> New Application
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- === EXACT SAME FOOTER FROM MAIN SITE === -->
  <footer>
    <div class="footer-container">
      <div class="footer-col">
        <h3>Pinecrest Academy</h3>
        <p>Providing excellence in education since 1985. Our mission is to empower students with knowledge, skills, and values that will enable them to become responsible global citizens and lifelong learners.</p>
        <div class="social-links">
          <a href="#"><i class="fab fa-facebook-f"></i></a>
          <a href="#"><i class="fab fa-twitter"></i></a>
          <a href="#"><i class="fab fa-instagram"></i></a>
          <a href="#"><i class="fab fa-linkedin-in"></i></a>
          <a href="#"><i class="fab fa-youtube"></i></a>
        </div>
      </div>
      <div class="footer-col">
        <h3>Quick Links</h3>
        <ul class="footer-links">
          <li><a href="index.html"><i class="fas fa-chevron-right"></i> Home</a></li>
          <li><a href="about.html"><i class="fas fa-chevron-right"></i> About Us</a></li>
          <li><a href="academic.html"><i class="fas fa-chevron-right"></i> Academics</a></li>
          <li><a href="admission.html"><i class="fas fa-chevron-right"></i> Admissions</a></li>
          <li><a href="resultchecker.html"><i class="fas fa-chevron-right"></i> Check Result</a></li>
          <li><a href="sport.html"><i class="fas fa-chevron-right"></i> Sports Activities</a></li>
          <li><a href="news.html"><i class="fas fa-chevron-right"></i> News & Events</a></li>
          <li><a href="contact_us.html"><i class="fas fa-chevron-right"></i> Contact Us</a></li>
          <li><a href="gallery.html"><i class="fas fa-chevron-right"></i> Gallery</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <h3>Contact Us</h3>
        <ul class="contact-info-footer">
          <li>
            <span class="contact-icon-footer"><i class="fas fa-map-marker-alt"></i></span>
            <span>12 Ewere street off upper sakponba road, Benin City</span>
          </li>
          <li>
            <span class="contact-icon-footer"><i class="fas fa-phone"></i></span>
            <span>+2347079878605</span>
          </li>
          <li>
            <span class="contact-icon-footer"><i class="fas fa-envelope"></i></span>
            <span>info@pinecrestacademy.edu</span>
          </li>
          <li>
            <span class="contact-icon-footer"><i class="fas fa-clock"></i></span>
            <span>Monday - Friday: 8:00 AM - 5:00 PM</span>
          </li>
        </ul>
      </div>
      <div class="footer-col">
        <h3>Developer Information</h3>
        <div class="developer-info" style="background:rgba(0,0,0,0.2);padding:25px;border-radius:10px;">
          <h4 style="color:#1a5fb4;margin-bottom:15px;">Website Developer</h4>
          <p style="color:#ccc;">For technical support or website inquiries, please contact:</p>
          <div style="display:flex;flex-wrap:wrap;gap:20px;margin-top:15px;">
            <div style="display:flex;align-items:center;gap:10px;flex:1;min-width:200px;color:#ccc;">
              <span style="color:#1a5fb4;"><i class="fas fa-user"></i></span>
              <span>smartdev-digital-solution</span>
            </div>
            <div style="display:flex;align-items:center;gap:10px;flex:1;min-width:200px;color:#ccc;">
              <span style="color:#1a5fb4;"><i class="fas fa-envelope"></i></span>
              <a href="mailto:smartdevhub9@gmail.com" style="color:#ccc;text-decoration:none;">smartdevhub9@gmail.com</a>
            </div>
            <div style="display:flex;align-items:center;gap:10px;flex:1;min-width:200px;color:#ccc;">
              <span style="color:#1a5fb4;"><i class="fas fa-phone"></i></span>
              <a href="tel:+2347079878605" style="color:#ccc;text-decoration:none;">+2347079878605</a>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="footer-bottom">
      <p>&copy; 2023 Pinecrest Academy. All Rights Reserved. | Designed with <i class="fas fa-heart" style="color: #1a5fb4;"></i> for Excellence in Education</p>
    </div>
  </footer>

  <!-- === Scripts: Mobile Nav + Firebase + Form Logic === -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      
      // Mobile Nav Toggle
      const hamburger = document.getElementById('hamburger-menu');
      const mobileNav = document.getElementById('mobileNav');
      const closeNav = document.getElementById('closeNav');
      const overlayNav = document.getElementById('overlayNav');

      hamburger.addEventListener('click', () => {
        mobileNav.classList.add('active');
        overlayNav.style.display = 'block';
        document.body.style.overflow = 'hidden';
      });
      [closeNav, overlayNav].forEach(el => {
        el.addEventListener('click', () => {
          mobileNav.classList.remove('active');
          overlayNav.style.display = 'none';
          document.body.style.overflow = 'auto';
        });
      });

      // Supabase Configuration
      const SUPABASE_URL = 'https://efiruwfplizcbrtgaajs.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVmaXJ1d2ZwbGl6Y2JydGdhYWpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5ODc1MTUsImV4cCI6MjA3MjU2MzUxNX0.k9FSDDvsEVaqYgNKZLSQcDaJUj8ISsDnAlQ3S8gUbeE';
      
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // Firebase Configuration
      const firebaseConfig = {
        apiKey: "AIzaSyDrMswvekwp-pGz4169DJCAS2jPNxlQ-9E",
        authDomain: "pinecrest-academy-school.firebaseapp.com",
        databaseURL: "https://pinecrest-academy-school-default-rtdb.firebaseio.com",
        projectId: "pinecrest-academy-school",
        storageBucket: "pinecrest-academy-school.firebasestorage.app",
        messagingSenderId: "642721831819",
        appId: "1:642721831819:web:560378e6412d5ed4622d8e",
        measurementId: "G-RD5PZNM3PS"
      };
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      // Form State Variables
      let currentStep = 0;
      let photoDataURL = null;
      let reportDataURL = null;
      let reportFileName = null;
      let applicationId = null;
      let pdfUrl = null;
      const steps = Array.from(document.querySelectorAll('.form-step'));
      const stepIndicators = document.querySelectorAll('.steps .step');

      // DOM Elements
      const formContainer = document.getElementById('formContainer');
      const receiptContainer = document.getElementById('receiptContainer');
      const photoInput = document.getElementById('photoInput');
      const photoPreview = document.getElementById('photoPreview');
      const previewImage = document.getElementById('previewImage');
      const photoError = document.getElementById('photoError');
      const photoErrorText = document.getElementById('photoErrorText');
      const photoUploadContainer = document.getElementById('photoUploadContainer');
      const reportInput = document.getElementById('reportInput');
      const reportPreview = document.getElementById('reportPreview');
      const previewReport = document.getElementById('previewReport');
      const reportError = document.getElementById('reportError');
      const reportErrorText = document.getElementById('reportErrorText');
      const reportUploadContainer = document.getElementById('reportUploadContainer');
      const uploadProgress = document.getElementById('uploadProgress');
      const uploadProgressBar = document.getElementById('uploadProgressBar');
      const uploadProgressText = document.getElementById('uploadProgressText');

      // Helper function to sanitize filename
      function sanitizeFilename(name) {
        return name
          .replace(/[^a-z0-9]/gi, '_') // Replace non-alphanumeric with underscore
          .replace(/_+/g, '_') // Replace multiple underscores with single
          .toLowerCase()
          .substring(0, 100); // Limit length
      }

      // Form Step Navigation
      function showStep(stepIndex) {
        steps.forEach((step, index) => {
          step.style.display = (index === stepIndex) ? 'block' : 'none';
          stepIndicators[index].classList.toggle('active', index === stepIndex);
        });
        currentStep = stepIndex;
        if (stepIndex === 5) buildReview();
      }

      function validateStep(stepIndex) {
        const step = steps[stepIndex];
        const requiredFields = Array.from(step.querySelectorAll('[required]'));
        
        if (stepIndex === 2) {
          if (!photoDataURL) {
            showPhotoError('Passport photograph is required');
            return false;
          }
          return true;
        }
        
        if (stepIndex === 3) {
          const classApplied = document.getElementById('classApplied').value;
          const isCrecheOrNursery = ['Creche', 'Nursery'].includes(classApplied);
          
          if (!isCrecheOrNursery && !reportDataURL) {
            showReportError('Academic report is required for this class level');
            return false;
          }
          return true;
        }
        
        for (const field of requiredFields) {
          if (!field.value.trim()) {
            field.focus();
            showStatus(`Please fill in: ${field.previousElementSibling.textContent.replace('*', '').trim()}`, false);
            return false;
          }
          
          if (field.type === 'email' && field.value.trim()) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(field.value.trim())) {
              field.focus();
              showStatus('Please enter a valid email address', false);
              return false;
            }
          }
          
          if (field.type === 'tel' && field.value.trim()) {
            const phoneRegex = /^[\d\s\-\+\(\)]{10,}$/;
            if (!phoneRegex.test(field.value.trim())) {
              field.focus();
              showStatus('Please enter a valid phone number', false);
              return false;
            }
          }
        }
        return true;
      }

      function showStatus(message, isSuccess = true) {
        const statusEl = document.getElementById('statusMsg');
        statusEl.textContent = message;
        statusEl.style.color = isSuccess ? '#155724' : '#721c24';
        statusEl.style.backgroundColor = isSuccess ? '#d4edda' : '#f8d7da';
        statusEl.style.border = isSuccess ? '1px solid #c3e6cb' : '1px solid #f5c6cb';
        statusEl.style.display = 'block';
        setTimeout(() => { if (statusEl.textContent === message) statusEl.style.display = 'none'; }, 5000);
      }

      // Photo Upload Handling
      function showPhotoError(message) {
        photoErrorText.textContent = message;
        photoError.style.display = 'block';
        photoUploadContainer.style.borderColor = '#dc3545';
        setTimeout(() => {
          photoError.style.display = 'none';
          photoUploadContainer.style.borderColor = '#1a5fb4';
        }, 5000);
      }

      function handlePhotoUpload(file) {
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png'];
        if (!validTypes.includes(file.type)) {
          showPhotoError('Please upload a JPG, JPEG, or PNG image');
          return;
        }
        if (file.size > 2 * 1024 * 1024) {
          showPhotoError('File size must be less than 2MB');
          return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
          photoDataURL = e.target.result;
          previewImage.src = photoDataURL;
          photoPreview.style.display = 'block';
          showStatus('Passport photograph uploaded successfully', true);
        };
        reader.readAsDataURL(file);
      }

      // Report Upload Handling
      function showReportError(message) {
        reportErrorText.textContent = message;
        reportError.style.display = 'block';
        reportUploadContainer.style.borderColor = '#dc3545';
        setTimeout(() => {
          reportError.style.display = 'none';
          reportUploadContainer.style.borderColor = '#28a745';
        }, 5000);
      }

      function handleReportUpload(file) {
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
        if (!validTypes.includes(file.type)) {
          showReportError('Please upload a PDF, JPG, JPEG, or PNG file');
          return;
        }
        if (file.size > 5 * 1024 * 1024) {
          showReportError('File size must be less than 5MB');
          return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
          reportDataURL = e.target.result;
          reportFileName = file.name;
          
          if (file.type.includes('image')) {
            previewReport.src = reportDataURL;
            reportPreview.style.display = 'block';
          } else {
            previewReport.src = 'https://cdn-icons-png.flaticon.com/512/337/337946.png';
            reportPreview.style.display = 'block';
          }
          showStatus('Academic report uploaded successfully', true);
        };
        reader.readAsDataURL(file);
      }

      // Drag and Drop for Photo Upload
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        photoUploadContainer.addEventListener(eventName, preventDefaults, false);
        reportUploadContainer.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      ['dragenter', 'dragover'].forEach(eventName => {
        photoUploadContainer.addEventListener(eventName, () => photoUploadContainer.classList.add('dragover'), false);
        reportUploadContainer.addEventListener(eventName, () => reportUploadContainer.classList.add('dragover'), false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
        photoUploadContainer.addEventListener(eventName, () => photoUploadContainer.classList.remove('dragover'), false);
        reportUploadContainer.addEventListener(eventName, () => reportUploadContainer.classList.remove('dragover'), false);
      });

      photoUploadContainer.addEventListener('drop', (e) => {
        const files = e.dataTransfer.files;
        if (files.length > 0) handlePhotoUpload(files[0]);
      }, false);

      reportUploadContainer.addEventListener('drop', (e) => {
        const files = e.dataTransfer.files;
        if (files.length > 0) handleReportUpload(files[0]);
      }, false);

      // Form Data Collection
      function getFormData() {
        const form = document.getElementById('admissionForm');
        const formData = new FormData(form);
        const data = {};
        for (const [key, value] of formData.entries()) data[key] = value;
        data.photoDataURL = photoDataURL;
        data.reportDataURL = reportDataURL;
        data.reportFileName = reportFileName;
        return data;
      }

      // Review Page Builder
      function buildReview() {
        const data = getFormData();
        const fullName = `${data.surname || ''} ${data.othernames || ''}`.trim();
        document.getElementById('review-student-name').textContent = fullName || '-';
        document.getElementById('review-dob').textContent = data.dob || '-';
        document.getElementById('review-gender').textContent = data.gender || '-';
        document.getElementById('review-class').textContent = data.classApplied || '-';
        document.getElementById('review-session').textContent = data.sessionApplied || '-';
        document.getElementById('review-parent').textContent = data.parentName || '-';
        document.getElementById('review-relationship').textContent = data.relationship || '-';
        document.getElementById('review-phone').textContent = data.phone || '-';
        document.getElementById('review-email').textContent = data.email || '-';
        document.getElementById('review-address').textContent = data.address || '-';
        document.getElementById('review-occupation').textContent = data.occupation || '-';
        document.getElementById('review-medical').textContent = data.medical || 'None';
        document.getElementById('review-allergies').textContent = data.allergies || 'None';
        document.getElementById('review-emergency').textContent = data.emergencyContact || '-';
        document.getElementById('review-doctor').textContent = data.doctorName || '-';
        document.getElementById('review-report-status').textContent = reportDataURL ? 'Uploaded' : 'Not Required';
        const reviewPhoto = document.getElementById('review-photo');
        if (photoDataURL) reviewPhoto.src = photoDataURL;
      }

      // Helper Functions
      function dataURLtoBlob(dataURL) {
        const arr = dataURL.split(',');
        const mime = arr[0].match(/:(.*?);/)[1];
        const bstr = atob(arr[1]);
        let n = bstr.length;
        const u8arr = new Uint8Array(n);
        while (n--) u8arr[n] = bstr.charCodeAt(n);
        return new Blob([u8arr], { type: mime });
      }

      function updateProgress(percentage, message) {
        uploadProgress.style.display = 'block';
        uploadProgressBar.style.width = `${percentage}%`;
        uploadProgressText.textContent = message;
      }

      // Generate PDF from HTML using html2canvas (same as image download)
      async function generatePDFFromHTML(appId, formData, studentName) {
        return new Promise((resolve, reject) => {
          try {
            updateProgress(30, 'Generating PDF from admission slip...');
            
            // First, capture the receipt container as image
            const receipt = document.getElementById('receiptContainer');
            
            html2canvas(receipt, {
              scale: 2,
              useCORS: true,
              logging: false,
              backgroundColor: '#ffffff'
            }).then(canvas => {
              // Create PDF with the canvas
              const { jsPDF } = window.jspdf;
              const doc = new jsPDF('p', 'mm', 'a4');
              const pageWidth = doc.internal.pageSize.getWidth();
              const pageHeight = doc.internal.pageSize.getHeight();
              
              // Calculate image dimensions to fit A4
              const imgWidth = pageWidth - 20; // 10mm margin on each side
              const imgHeight = (canvas.height * imgWidth) / canvas.width;
              
              // Add admission slip as first page
              const imgData = canvas.toDataURL('image/jpeg', 0.9);
              doc.addImage(imgData, 'JPEG', 10, 10, imgWidth, imgHeight);
              
              // Add new page for academic report if exists
              if (formData.reportDataURL && !formData.reportFileName?.toLowerCase().endsWith('.pdf')) {
                doc.addPage();
                
                // Add header for report page
                doc.setFillColor(26, 95, 180);
                doc.rect(0, 0, pageWidth, 20, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('Previous School Academic Report', pageWidth / 2, 12, { align: 'center' });
                
                // Add student info
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text(`Student: ${studentName}`, 10, 30);
                doc.text(`Application ID: ${appId}`, 10, 40);
                doc.text(`Class Applied: ${formData.classApplied || ''}`, 10, 50);
                doc.text(`Session: ${formData.sessionApplied || ''}`, 10, 60);
                
                // Add report image
                try {
                  const reportImg = new Image();
                  reportImg.src = formData.reportDataURL;
                  
                  reportImg.onload = function() {
                    // Calculate dimensions for the report image
                    const reportImgWidth = pageWidth - 40;
                    let reportImgHeight = (reportImg.height * reportImgWidth) / reportImg.width;
                    
                    // If image is too tall, reduce height
                    if (reportImgHeight > pageHeight - 80) {
                      reportImgHeight = pageHeight - 80;
                    }
                    
                    // Add the image to PDF
                    doc.addImage(reportImg, 'JPEG', 20, 70, reportImgWidth, reportImgHeight);
                    
                    // Add footer
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Report submitted: ${new Date().toLocaleDateString()}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                    
                    finishPDF();
                  };
                  
                  reportImg.onerror = function() {
                    // If image fails to load, add placeholder
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Academic report attached but could not be displayed in PDF.', 10, 80);
                    doc.text('Original file available in school records.', 10, 90);
                    
                    finishPDF();
                  };
                } catch (error) {
                  console.warn('Error adding report image to PDF:', error);
                  doc.setFontSize(12);
                  doc.setFont('helvetica', 'normal');
                  doc.text('Academic report attached to application.', 10, 80);
                  
                  finishPDF();
                }
              } else if (formData.reportDataURL && formData.reportFileName?.toLowerCase().endsWith('.pdf')) {
                // For PDF reports, we'll store them separately but note in the PDF
                doc.addPage();
                
                // Add header for report page
                doc.setFillColor(26, 95, 180);
                doc.rect(0, 0, pageWidth, 20, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('Previous School Academic Report', pageWidth / 2, 12, { align: 'center' });
                
                // Add student info
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text(`Student: ${studentName}`, 10, 30);
                doc.text(`Application ID: ${appId}`, 10, 40);
                doc.text(`Class Applied: ${formData.classApplied || ''}`, 10, 50);
                doc.text(`Session: ${formData.sessionApplied || ''}`, 10, 60);
                
                // Add note about PDF report
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('PDF REPORT ATTACHED', pageWidth / 2, 90, { align: 'center' });
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text(`Report File: ${formData.reportFileName || 'academic_report.pdf'}`, 10, 110);
                doc.text('Note: The full academic report PDF is stored separately in the system.', 10, 125);
                doc.text('School administration can access it through the application portal.', 10, 140);
                
                finishPDF();
              } else {
                // No report, just add page number
                finishPDF();
              }
              
              function finishPDF() {
                // Add page number
                const totalPages = doc.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                  doc.setPage(i);
                  doc.setFontSize(10);
                  doc.setTextColor(100, 100, 100);
                  doc.text(`Page ${i} of ${totalPages}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                }
                
                // Finalize PDF
                updateProgress(70, 'Finalizing PDF...');
                const pdfBlob = doc.output('blob');
                const pdfDataUrl = doc.output('datauristring');
                
                updateProgress(100, 'PDF generated successfully!');
                setTimeout(() => { uploadProgress.style.display = 'none'; }, 1000);
                
                resolve({ pdfBlob, pdfUrl: pdfDataUrl, pdfDoc: doc });
              }
            }).catch(error => {
              console.error('Error generating PDF from HTML:', error);
              // Fallback to regular PDF generation
              generateRegularPDF(appId, formData, studentName).then(resolve).catch(reject);
            });
            
          } catch (error) {
            console.error('PDF Generation Error:', error);
            uploadProgress.style.display = 'none';
            reject(error);
          }
        });
      }

      // Fallback PDF generation (used if html2canvas fails)
      async function generateRegularPDF(appId, formData, studentName) {
        return new Promise((resolve, reject) => {
          try {
            updateProgress(30, 'Generating regular PDF...');
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 20;
            let yPos = 15;
            
            // Header Section
            doc.setFillColor(26, 95, 180);
            doc.rect(0, 0, pageWidth, 30, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text('Pinecrest Academy', pageWidth / 2, 12, { align: 'center' });
            doc.setFontSize(14);
            doc.text('Admission Application Receipt', pageWidth / 2, 20, { align: 'center' });
            
            // Application ID
            yPos = 35;
            doc.setTextColor(26, 95, 180);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(`APPLICATION ID: ${appId}`, margin, yPos);
            
            // Student Information
            yPos += 15;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            
            const infoLines = [
              `Student Name: ${studentName}`,
              `Date of Birth: ${formData.dob || ''}`,
              `Gender: ${formData.gender || ''}`,
              `Class Applied: ${formData.classApplied || ''}`,
              `Session: ${formData.sessionApplied || ''}`,
              `Parent: ${formData.parentName || ''}`,
              `Relationship: ${formData.relationship || ''}`,
              `Phone: ${formData.phone || ''}`,
              `Email: ${formData.email || ''}`,
              `Address: ${formData.address || ''}`,
              `Current School: ${formData.currentSchool || ''}`,
              `Medical Conditions: ${formData.medical || 'None'}`,
              `Allergies: ${formData.allergies || 'None'}`,
              `Emergency Contact: ${formData.emergencyContact || ''}`
            ];
            
            infoLines.forEach(line => {
              if (yPos > pageHeight - 50) {
                doc.addPage();
                yPos = 20;
              }
              doc.text(line, margin, yPos);
              yPos += 7;
            });
            
            // Confirmation Text
            yPos += 10;
            doc.setFont('helvetica', 'italic');
            doc.setFontSize(10);
            const confirmation = 'This slip confirms that the above-named applicant has successfully completed and submitted an online application. The applicant is required to present this slip at the school for admission processing.';
            doc.text(confirmation, margin, yPos, { maxWidth: pageWidth - 2*margin });
            
            // Footer
            yPos = pageHeight - 20;
            doc.setFontSize(9);
            doc.setTextColor(100, 100, 100);
            doc.setFont('helvetica', 'normal');
            doc.text(`Application ID: ${appId} | Generated: ${new Date().toLocaleString()}`, pageWidth / 2, yPos, { align: 'center' });
            
            updateProgress(70, 'Finalizing PDF...');
            const pdfBlob = doc.output('blob');
            const pdfDataUrl = doc.output('datauristring');
            
            updateProgress(100, 'PDF generated successfully!');
            setTimeout(() => { uploadProgress.style.display = 'none'; }, 1000);
            
            resolve({ pdfBlob, pdfUrl: pdfDataUrl, pdfDoc: doc });
          } catch (error) {
            console.error('Regular PDF Generation Error:', error);
            uploadProgress.style.display = 'none';
            reject(error);
          }
        });
      }

      // Upload PDF to Supabase with student's name as filename
      async function uploadPDFToSupabase(pdfBlob, appId, studentName, className) {
        try {
          updateProgress(0, 'Preparing to upload PDF...');
          
          // Sanitize student name for filename
          const sanitizedStudentName = sanitizeFilename(studentName);
          const sanitizedClassName = sanitizeFilename(className);
          const timestamp = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
          
          // Create filename with student's name: StudentName_ClassName_YYYY-MM-DD_ApplicationID.pdf
          const filename = `${sanitizedStudentName}_${sanitizedClassName}_${timestamp}_${appId}.pdf`;
          
          updateProgress(20, `Uploading PDF as: ${filename}...`);
          const { data, error } = await supabase.storage
            .from('database')
            .upload(`applications/${filename}`, pdfBlob, {
              contentType: 'application/pdf',
              upsert: true
            });
          
          if (error) throw error;
          
          updateProgress(80, 'Generating secure URL...');
          const { data: urlData } = supabase.storage
            .from('database')
            .getPublicUrl(`applications/${filename}`);
          
          updateProgress(100, 'PDF uploaded successfully with student name!');
          setTimeout(() => { uploadProgress.style.display = 'none'; }, 1000);
          
          return {
            success: true,
            filename: filename,
            path: data.path,
            publicUrl: urlData.publicUrl,
            fullPath: `applications/${filename}`
          };
        } catch (error) {
          console.error('Upload failed:', error);
          uploadProgress.style.display = 'none';
          return { success: false, error: error.message };
        }
      }

      // Receipt Builder
      function buildReceipt(data, appId, pdfSuccess = true) {
        const fullName = `${data.surname || ''} ${data.othernames || ''}`.trim();
        document.getElementById('receiptAppId').textContent = `APPLICATION ID: ${appId}`;
        document.getElementById('receiptStudentName').textContent = fullName || '-';
        document.getElementById('receiptDOB').textContent = data.dob || '-';
        document.getElementById('receiptGender').textContent = data.gender || '-';
        document.getElementById('receiptClass').textContent = data.classApplied || '-';
        document.getElementById('receiptSession').textContent = data.sessionApplied || '-';
        document.getElementById('receiptParent').textContent = data.parentName || '-';
        document.getElementById('receiptRelationship').textContent = data.relationship || '-';
        document.getElementById('receiptPhone').textContent = data.phone || '-';
        document.getElementById('receiptEmail').textContent = data.email || '-';
        document.getElementById('receiptAddress').textContent = data.address || '-';
        document.getElementById('receiptSchool').textContent = data.currentSchool || '-';
        document.getElementById('receiptMedical').textContent = data.medical || 'None';
        document.getElementById('receiptAllergies').textContent = data.allergies || 'None';
        document.getElementById('receiptEmergency').textContent = data.emergencyContact || '-';
        
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('receiptDate').textContent = now.toLocaleDateString('en-US', options);
        
        const pdfStatus = document.getElementById('receiptPDFStatus');
        if (pdfSuccess) {
          pdfStatus.textContent = 'GENERATED & UPLOADED';
          pdfStatus.style.color = '#28a745';
        } else {
          pdfStatus.textContent = 'GENERATION FAILED';
          pdfStatus.style.color = '#dc3545';
        }
        
        const receiptPhoto = document.getElementById('receiptPhoto');
        if (data.photoDataURL) receiptPhoto.src = data.photoDataURL;
      }

      // Form Submission
      async function submitForm() {
        const data = getFormData();
        const fullName = `${data.surname || ''} ${data.othernames || ''}`.trim();
        
        if (!data.surname || !data.othernames || !data.parentName || !data.phone || !data.classApplied || !data.emergencyContact || !data.sessionApplied) {
          showStatus('Please complete all required fields', false);
          return null;
        }
        
        if (!photoDataURL) {
          showStatus('Passport photograph is required', false);
          return null;
        }
        
        const classApplied = data.classApplied;
        const isCrecheOrNursery = ['Creche', 'Nursery'].includes(classApplied);
        
        if (!isCrecheOrNursery && !reportDataURL) {
          showStatus('Academic report is required for this class level', false);
          return null;
        }
        
        let appId = null;
        let pdfUploadSuccess = false;
        
        try {
          const ref = database.ref('admissions').push();
          appId = ref.key;
          applicationId = appId;
          
          const submissionData = {
            ...data,
            studentFullName: fullName,
            createdAt: new Date().toISOString(),
            status: 'pending',
            applicationId: appId,
            submittedAt: firebase.database.ServerValue.TIMESTAMP,
            pdfGenerated: false,
            pdfUrl: null,
            pdfFilename: null,
            reportUploaded: !!reportDataURL
          };
          
          delete submissionData.photoDataURL;
          delete submissionData.reportDataURL;
          
          await ref.set(submissionData);
          
          // Generate PDF using html2canvas (same as image)
          showStatus('Generating application PDF...', true);
          const pdfResult = await generatePDFFromHTML(appId, data, fullName);
          
          // Upload PDF to Supabase with student's name as filename
          showStatus('Uploading PDF to secure storage...', true);
          const uploadResult = await uploadPDFToSupabase(pdfResult.pdfBlob, appId, fullName, data.classApplied);
          
          if (uploadResult.success) {
            pdfUploadSuccess = true;
            pdfUrl = uploadResult.publicUrl;
            
            // Update Firebase with PDF URL and filename
            await ref.update({
              pdfUrl: uploadResult.publicUrl,
              pdfPath: uploadResult.path,
              pdfFilename: uploadResult.filename,
              pdfGenerated: true,
              pdfGeneratedAt: new Date().toISOString()
            });
            
            // Upload passport photo with student's name
            if (photoDataURL) {
              try {
                const photoBlob = dataURLtoBlob(photoDataURL);
                const photoFilename = `photo_${sanitizeFilename(fullName)}_${appId}.jpg`;
                await supabase.storage.from('database').upload(`photos/${photoFilename}`, photoBlob, {
                  contentType: 'image/jpeg', upsert: true
                });
                const { data: photoUrlData } = supabase.storage.from('database').getPublicUrl(`photos/${photoFilename}`);
                await ref.update({ 
                  photoUrl: photoUrlData.publicUrl,
                  photoFilename: photoFilename
                });
              } catch (photoError) { 
                console.warn('Photo upload failed:', photoError);
                // Continue even if photo upload fails
              }
            }
            
            // Upload academic report with student's name
            if (reportDataURL) {
              try {
                const reportBlob = dataURLtoBlob(reportDataURL);
                const reportFileExt = reportFileName?.split('.').pop() || 'jpg';
                const reportFilename = `report_${sanitizeFilename(fullName)}_${appId}.${reportFileExt}`;
                await supabase.storage.from('database').upload(`reports/${reportFilename}`, reportBlob, {
                  contentType: reportFileName?.endsWith('.pdf') ? 'application/pdf' : 'image/jpeg',
                  upsert: true
                });
                const { data: reportUrlData } = supabase.storage.from('database').getPublicUrl(`reports/${reportFilename}`);
                await ref.update({ 
                  reportUrl: reportUrlData.publicUrl,
                  reportFilename: reportFilename
                });
              } catch (reportError) { 
                console.warn('Report upload failed:', reportError);
                // Continue even if report upload fails
              }
            }
            
            showStatus('Application submitted and PDF uploaded to secure storage!', true);
          } else {
            showStatus('Application submitted, but PDF upload failed. Please contact support.', false);
          }
          
          return { appId, pdfUploadSuccess, studentName: fullName };
        } catch (error) {
          console.error('Submission error:', error);
          showStatus('Submission failed. Please try again.', false);
          return { appId: null, pdfUploadSuccess: false };
        }
      }

      // Download PDF Receipt
      async function downloadPDF() {
        try {
          if (!applicationId) {
            showStatus('No application found to download', false);
            return;
          }
          const formData = getFormData();
          const fullName = `${formData.surname || ''} ${formData.othernames || ''}`.trim();
          showStatus('Generating PDF for download...', true);
          const pdfResult = await generatePDFFromHTML(applicationId, formData, fullName);
          const link = document.createElement('a');
          link.download = `Pinecrest-Admission-${sanitizeFilename(fullName)}-${applicationId}.pdf`;
          link.href = URL.createObjectURL(pdfResult.pdfBlob);
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          showStatus('PDF downloaded successfully!', true);
        } catch (error) {
          console.error('PDF download failed:', error);
          showStatus('PDF download failed. Try downloading as image instead.', false);
        }
      }

      // Download Image Receipt
      function downloadImageReceipt() {
        const receipt = document.getElementById('receiptContainer');
        html2canvas(receipt, { scale: 2, useCORS: true, logging: false, backgroundColor: '#ffffff' })
          .then(canvas => {
            const formData = getFormData();
            const fullName = `${formData.surname || ''} ${formData.othernames || ''}`.trim();
            const link = document.createElement('a');
            link.download = `Pinecrest-Admission-${sanitizeFilename(fullName)}-${applicationId}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
          });
      }

      function printReceipt() {
        const originalContent = document.body.innerHTML;
        const receiptContent = document.getElementById('receiptContainer').innerHTML;
        document.body.innerHTML = receiptContent;
        window.print();
        document.body.innerHTML = originalContent;
        location.reload();
      }

      // Event Listeners
      photoInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) handlePhotoUpload(e.target.files[0]);
      });

      reportInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) handleReportUpload(e.target.files[0]);
      });

      // Step Navigation
      document.getElementById('nextBtn1').addEventListener('click', () => { if (validateStep(0)) showStep(1); });
      document.getElementById('nextBtn2').addEventListener('click', () => { if (validateStep(1)) showStep(2); });
      document.getElementById('nextBtn3').addEventListener('click', () => { if (validateStep(2)) showStep(3); });
      document.getElementById('nextBtn4').addEventListener('click', () => { if (validateStep(3)) showStep(4); });
      document.getElementById('nextBtn5').addEventListener('click', () => { if (validateStep(4)) showStep(5); });
      
      document.getElementById('prevBtn2').addEventListener('click', () => showStep(0));
      document.getElementById('prevBtn3').addEventListener('click', () => showStep(1));
      document.getElementById('prevBtn4').addEventListener('click', () => showStep(2));
      document.getElementById('prevBtn5').addEventListener('click', () => showStep(3));
      document.getElementById('prevBtn6').addEventListener('click', () => showStep(4));

      // Form submission
      document.getElementById('admissionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
        
        const result = await submitForm();
        
        if (result && result.appId) {
          const formData = getFormData();
          buildReceipt(formData, result.appId, result.pdfUploadSuccess);
          formContainer.style.display = 'none';
          receiptContainer.style.display = 'block';
          receiptContainer.scrollIntoView({ behavior: 'smooth' });
          showStatus(`Application submitted successfully! PDF saved as: ${result.studentName}_${formData.classApplied}_${applicationId}.pdf`, true);
        } else {
          showStatus('Submission failed. Please check your connection and try again.', false);
        }
        
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Application';
      });

      // Receipt actions
      document.getElementById('printReceiptBtn').addEventListener('click', printReceipt);
      document.getElementById('downloadPDFBtn').addEventListener('click', downloadPDF);
      document.getElementById('downloadImageBtn').addEventListener('click', downloadImageReceipt);
      document.getElementById('newApplicationBtn').addEventListener('click', () => {
        document.getElementById('admissionForm').reset();
        photoDataURL = null;
        reportDataURL = null;
        reportFileName = null;
        photoPreview.style.display = 'none';
        reportPreview.style.display = 'none';
        previewImage.src = '';
        previewReport.src = '';
        document.getElementById('review-photo').src = '';
        applicationId = null;
        pdfUrl = null;
        receiptContainer.style.display = 'none';
        formContainer.style.display = 'block';
        showStep(0);
        formContainer.scrollIntoView({ behavior: 'smooth' });
        showStatus('Start a new application', true);
      });

      // Initialize form
      showStep(0);
    });
  </script>
</body>
</html>